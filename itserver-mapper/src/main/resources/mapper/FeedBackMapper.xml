<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.longfor.itserver.mapper.FeedBackMapper">
    <resultMap id="BaseResultMap" type="com.longfor.itserver.entity.FeedBack">
        <!--
          WARNING - @mbggenerated
        -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="product_id" property="productId" jdbcType="BIGINT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="product_code" jdbcType="VARCHAR" property="productCode" />
        <result column="problem_title" property="problemTitle" jdbcType="VARCHAR"/>
        <result column="problem_descp" property="problemDescp" jdbcType="VARCHAR"/>
        <result column="reproduction_step" property="reproductionStep" jdbcType="VARCHAR"/>
        <result column="sys_environment" property="sysEnvironment" jdbcType="VARCHAR"/>
        <result column="contact_account_id" property="contactAccountId" jdbcType="VARCHAR"/>
        <result column="contact_employee_code" property="contactEmployeeCode" jdbcType="BIGINT"/>
        <result column="contact_employee_name" property="contactEmployeeName" jdbcType="VARCHAR"/>
        <result column="contact_full_dept_path" property="contactFullDeptPath" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="channel" property="channel" jdbcType="INTEGER"/>
        <result column="modified_account_id" property="modifiedAccountId" jdbcType="VARCHAR"/>
        <result column="modified_employee_code" property="modifiedEmployeeCode" jdbcType="BIGINT"/>
        <result column="modified_name" property="modifiedName" jdbcType="VARCHAR"/>
        <result column="modified_full_dept_path" property="modifiedFullDeptPath" jdbcType="VARCHAR"/>
        <result column="file_path" property="filePath" jdbcType="LONGVARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="modified_time" property="modifiedTime" jdbcType="TIMESTAMP"/>
        <result column="feedback_phone" property="feedbackPhone" jdbcType="VARCHAR" />
        <result column="feedback_name" property="feedbackName" jdbcType="VARCHAR" />
    </resultMap>


    <resultMap id="FeedBackDetailResultMap" extends="BaseResultMap"
               type="com.longfor.itserver.entity.ps.PsFeedBackDetail">

    </resultMap>

    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
        -->
        id, product_id, product_code, name, problem_title, problem_descp, reproduction_step, sys_environment,
        contact_account_id, contact_employee_code, contact_employee_name, contact_full_dept_path,
        type, status, channel, modified_account_id, modified_employee_code, modified_name,
        modified_full_dept_path, file_path, create_time, modified_time, feedback_phone,
        feedback_name
    </sql>

    <!-- 反馈列表 -->
  <select id="feedBackList" parameterType="map" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />
    FROM feed_back
    WHERE 1=1
      <if test='accountId != "" and accountId != null'>
          and modified_account_id = #{accountId}
      </if>
      <if test='feedbackPhone != "" and feedbackPhone != null and (accountId == "" or accountId == null)'>
          and feedback_phone = #{feedbackPhone}
      </if>
    <if test='type != "" and type != null  and type != -1'>
      and type = #{type}
    </if>
    <if test='status != "" and status != null  and status != -1'>
      and status = #{status}
    </if>
    <if test='channel != "" and channel != null  and channel != -1'>
      and channel = #{channel}
    </if>
    <if test='searchText != "" and searchText != null'>
      and (name like concat(concat('%',#{searchText}),'%'))
    </if>
    ORDER BY create_time DESC
  </select>

    <!-- 通过ID查询BUG -->
    <select id="getFeedBackId" parameterType="java.lang.Long" resultMap="FeedBackDetailResultMap">
        SELECT *
        FROM feed_back
        WHERE id = #{id}
    </select>


    <!-- 反馈表状态统计 -->
    <select id="countStatus" parameterType="map" resultType="com.longfor.itserver.entity.ps.PsFeedBackStatus">
        SELECT
            IFNULL(sum(f.`status` = 0),0) AS "cancel",
            IFNULL(sum(f.`status` = 1),0) AS "close",
            IFNULL(sum(f.`status` = 2),0) AS "pending",
            IFNULL(sum(f.`status` = 3),0) AS "working",
            IFNULL(sum(f.`status` = 4),0) AS "completed"
        FROM feed_back f
        WHERE 1 = 1
        <if test='accountId != "" and accountId != null'>
            and modified_account_id = #{accountId}
        </if>
        <if test='feedbackPhone != "" and feedbackPhone != null and (accountId == "" or accountId == null)'>
            and feedback_phone = #{feedbackPhone}
        </if>
    </select>

</mapper>